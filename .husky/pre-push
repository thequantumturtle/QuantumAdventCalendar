#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Cross-platform pre-push hook that runs a quick Docker-based smoke test.
# - Prefer the POSIX script (calls docker-compose)
# - Fall back to PowerShell script if pwsh is available
# - If neither docker nor pwsh is available, skip with a clear warning

echo "Running strict pre-push smoke tests (Docker required)..."

# Enforce that Docker is present. We require Docker for all local tests.
if ! command -v docker >/dev/null 2>&1; then
  echo "ERROR: 'docker' command not found in PATH."
  echo "This repository requires Docker to run local pre-push smoke tests."
  echo "Please install Docker Desktop (macOS/Windows) or Docker Engine (Linux) and ensure 'docker' is on your PATH."
  echo "If you intentionally want to bypass pre-push checks, use: git push --no-verify (not recommended)"
  exit 1
fi

echo "Found docker. Attempting POSIX smoke test..."
if command -v sh >/dev/null 2>&1 && [ -x ./scripts/test-local.sh ]; then
  sh ./scripts/test-local.sh
  exit_code=$?
  if [ $exit_code -eq 0 ]; then
    echo "POSIX smoke tests passed. Proceeding with push."
    exit 0
  else
    echo "POSIX smoke tests failed (exit $exit_code)."
  fi
else
  echo "POSIX shell or script not available, will try PowerShell fallback if present."
fi

if command -v pwsh >/dev/null 2>&1 && [ -f ./scripts/test-local.ps1 ]; then
  echo "Running PowerShell smoke test (fallback)..."
  pwsh -NoProfile -ExecutionPolicy Bypass -File ./scripts/test-local.ps1
  exit_code=$?
  if [ $exit_code -eq 0 ]; then
    echo "PowerShell smoke tests passed. Proceeding with push."
    exit 0
  else
    echo "PowerShell smoke tests failed (exit $exit_code). Aborting push."
    exit $exit_code
  fi
fi

echo "No suitable smoke-test runner available (POSIX shell or PowerShell). Aborting push."
exit 1
