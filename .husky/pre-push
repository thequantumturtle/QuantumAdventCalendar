#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Cross-platform pre-push hook that runs a quick Docker-based smoke test.
# - Prefer the POSIX script (calls docker-compose)
# - Fall back to PowerShell script if pwsh is available
# - If neither docker nor pwsh is available, skip with a clear warning

echo "Running strict pre-push smoke tests (Docker required)..."

# Enforce that Docker is present. We require Docker for all local tests.
if ! command -v docker >/dev/null 2>&1; then
  echo "ERROR: 'docker' command not found in PATH."
  echo "This repository requires Docker to run local pre-push smoke tests."
  echo "Please install Docker Desktop (macOS/Windows) or Docker Engine (Linux) and ensure 'docker' is on your PATH."
  echo "If you intentionally want to bypass pre-push checks, use: git push --no-verify (not recommended)"
  exit 1
fi

echo "Found docker. Running POSIX smoke test..."
sh ./scripts/test-local.sh
exit_code=$?
if [ $exit_code -ne 0 ]; then
  echo "Smoke tests failed (exit $exit_code). Aborting push."
  exit $exit_code
fi

echo "Smoke tests passed. Proceeding with push."
exit 0
